(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.cozysdk = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
// Generated by CoffeeScript 1.8.0
(function() {
  var checkError, client, define, errorMaker;

  client = require('./utils/client');

  checkError = function(error, response, body, code, callback) {
    return callback(errorMaker(error, response, body, code));
  };

  errorMaker = function(error, response, body, expectedCode) {
    var err, msgStatus;
    if (error) {
      return error;
    } else if (response.status !== expectedCode) {
      msgStatus = "expected: " + expectedCode + ", got: " + response.statusCode;
      err = new Error("" + msgStatus + " -- " + body.error + " -- " + body.reason);
      err.status = response.statusCode;
      return err;
    } else {
      return null;
    }
  };

  define = function(docType, name, request, callback) {
    var map, path, reduce, reduceArgsAndBody, view;
    map = request.map, reduce = request.reduce;
    if ((reduce != null) && typeof reduce === 'function') {
      reduce = reduce.toString();
      reduceArgsAndBody = reduce.slice(reduce.indexOf('('));
      reduce = "function " + reduceArgsAndBody;
    }
    view = {
      reduce: reduce,
      map: "function (doc) {\n  if (doc.docType.toLowerCase() === \"" + (docType.toLowerCase()) + "\") {\n    filter = " + (map.toString()) + ";\n    filter(doc);\n  }\n}"
    };
    path = "request/" + docType + "/" + (name.toLowerCase()) + "/";
    return client.put(path, view, function(error, body, response) {
      return checkError(error, response, body, 200, callback);
    });
  };

  module.exports.create = function(docType, attributes, callback) {
    var path;
    path = "data/";
    attributes.docType = docType;
    if (attributes.id != null) {
      path += "" + attributes.id + "/";
      delete attributes.id;
      return callback(new Error('cant create an object with a set id'));
    }
    return client.post(path, attributes, function(error, body, response) {
      if (error) {
        return callback(error);
      } else {
        return callback(null, JSON.parse(body));
      }
    });
  };

  module.exports.find = function(id, callback) {
    return client.get("data/" + id + "/", null, function(error, body, response) {
      if (error) {
        return callback(error);
      } else if (response.status === 404) {
        return callback(null, null, null);
      } else {
        return callback(null, body);
      }
    });
  };

  module.exports.exists = function(id, callback) {
    return client.get("data/exist/" + id + "/", null, function(error, body, response) {
      if (error) {
        return callback(error);
      } else if ((body == null) || (body.exist == null)) {
        return callback(new Error("Data system returned invalid data."));
      } else {
        return callback(null, body.exist);
      }
    });
  };

  module.exports.updateAttributes = function(docType, id, attributes, callback) {
    console.log('updateAttributes');
    attributes.docType = docType;
    return client.put("data/merge/" + id + "/", attributes, function(error, body, response) {
      if (error) {
        return callback(error);
      } else if (response.status === 404) {
        return callback(new Error("Document " + id + " not found"));
      } else if (response.status !== 200) {
        return callback(new Error("Server error occured."));
      } else {
        return callback(null, JSON.parse(body));
      }
    });
  };

  module.exports.destroy = function(id, callback) {
    return client.del("data/" + id + "/", null, function(error, body, response) {
      if (error) {
        return callback(error);
      } else if (response.status === 404) {
        return callback(new Error("Document " + id + " not found"));
      } else if (response.status !== 204) {
        return callback(new Error("Server error occured."));
      } else {
        return callback(null);
      }
    });
  };

  module.exports.defineRequest = function(docType, name, request, callback) {
    var map, reduce;
    if (typeof request === "function" || typeof request === 'string') {
      map = request;
    } else {
      map = request.map;
      reduce = request.reduce;
    }
    return define(docType, name, {
      map: map,
      reduce: reduce
    }, callback);
  };

  module.exports.run = function(docType, name, params, callback) {
    var path, _ref;
    if (typeof params === "function") {
      _ref = [{}, params], params = _ref[0], callback = _ref[1];
    }
    path = "request/" + docType + "/" + (name.toLowerCase()) + "/";
    return client.post(path, params, function(error, body, response) {
      if (error) {
        return callback(error);
      } else if (response.status !== 200) {
        return callback(new Error(util.inspect(body)));
      } else {
        return callback(null, body);
      }
    });
  };

  module.exports.requestDestroy = function(docType, name, params, callback) {
    var path, _ref;
    if (typeof params === "function") {
      _ref = [{}, params], params = _ref[0], callback = _ref[1];
    }
    if (params.limit == null) {
      params.limit = 100;
    }
    path = "request/" + docType + "/" + (name.toLowerCase()) + "/destroy/";
    return client.put(path, params, function(error, body, response) {
      return checkError(error, response, body, 204, callback);
    });
  };

}).call(this);

},{"./utils/client":2}],2:[function(require,module,exports){
// Generated by CoffeeScript 1.8.0
(function() {
  var getToken, playRequest;

  getToken = function(callback) {
    console.log('getToken');
    window.parent.postMessage({
      action: 'getToken'
    }, '*');
    return window.addEventListener('message', function(event) {
      var intent;
      intent = event.data;
      window.removeEventListener("message", arguments.callee);
      return callback(intent);
    });
  };

  module.exports = {
    get: function(path, attributes, callback) {
      return playRequest('GET', path, attributes, function(error, body, response) {
        return callback(error, body, response);
      });
    },
    post: function(path, attributes, callback) {
      return playRequest('POST', path, attributes, function(error, body, response) {
        return callback(error, body, response);
      });
    },
    put: function(path, attributes, callback) {
      console.log('put');
      return playRequest('PUT', path, attributes, function(error, body, response) {
        return callback(error, body, response);
      });
    },
    del: function(path, attributes, callback) {
      return playRequest('DELETE', path, attributes, function(error, body, response) {
        return callback(error, body, response);
      });
    }
  };

  playRequest = function(method, path, attributes, callback) {
    var xhr;
    xhr = new XMLHttpRequest;
    xhr.open(method, "/ds-api/" + path, true);
    xhr.onload = function() {
      console.log(xhr.response);
      return callback(null, xhr.response, xhr);
    };
    xhr.onerror = function(e) {
      var err;
      err = 'Request failed : #{e.target.status}';
      return callback(err);
    };
    return getToken(function(res) {
      console.log('addEventListener');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('Authorization', 'Basic ' + btoa(res.appName + ':' + res.token));
      if (attributes != null) {
        return xhr.send(JSON.stringify(attributes));
      } else {
        return xhr.send();
      }
    });
  };

}).call(this);

},{}]},{},[1])(1)
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Vzci9sb2NhbC9saWIvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL2Jyb3dzZXItcGFjay9fcHJlbHVkZS5qcyIsImxpYi9pbmRleC5qcyIsImxpYi91dGlscy9jbGllbnQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUNBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2hLQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImdlbmVyYXRlZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24gZSh0LG4scil7ZnVuY3Rpb24gcyhvLHUpe2lmKCFuW29dKXtpZighdFtvXSl7dmFyIGE9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3ZhciBmPW5ldyBFcnJvcihcIkNhbm5vdCBmaW5kIG1vZHVsZSAnXCIrbytcIidcIik7dGhyb3cgZi5jb2RlPVwiTU9EVUxFX05PVF9GT1VORFwiLGZ9dmFyIGw9bltvXT17ZXhwb3J0czp7fX07dFtvXVswXS5jYWxsKGwuZXhwb3J0cyxmdW5jdGlvbihlKXt2YXIgbj10W29dWzFdW2VdO3JldHVybiBzKG4/bjplKX0sbCxsLmV4cG9ydHMsZSx0LG4scil9cmV0dXJuIG5bb10uZXhwb3J0c312YXIgaT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS44LjBcbihmdW5jdGlvbigpIHtcbiAgdmFyIGNoZWNrRXJyb3IsIGNsaWVudCwgZGVmaW5lLCBlcnJvck1ha2VyO1xuXG4gIGNsaWVudCA9IHJlcXVpcmUoJy4vdXRpbHMvY2xpZW50Jyk7XG5cbiAgY2hlY2tFcnJvciA9IGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSwgYm9keSwgY29kZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gY2FsbGJhY2soZXJyb3JNYWtlcihlcnJvciwgcmVzcG9uc2UsIGJvZHksIGNvZGUpKTtcbiAgfTtcblxuICBlcnJvck1ha2VyID0gZnVuY3Rpb24oZXJyb3IsIHJlc3BvbnNlLCBib2R5LCBleHBlY3RlZENvZGUpIHtcbiAgICB2YXIgZXJyLCBtc2dTdGF0dXM7XG4gICAgaWYgKGVycm9yKSB7XG4gICAgICByZXR1cm4gZXJyb3I7XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IGV4cGVjdGVkQ29kZSkge1xuICAgICAgbXNnU3RhdHVzID0gXCJleHBlY3RlZDogXCIgKyBleHBlY3RlZENvZGUgKyBcIiwgZ290OiBcIiArIHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICBlcnIgPSBuZXcgRXJyb3IoXCJcIiArIG1zZ1N0YXR1cyArIFwiIC0tIFwiICsgYm9keS5lcnJvciArIFwiIC0tIFwiICsgYm9keS5yZWFzb24pO1xuICAgICAgZXJyLnN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICByZXR1cm4gZXJyO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH07XG5cbiAgZGVmaW5lID0gZnVuY3Rpb24oZG9jVHlwZSwgbmFtZSwgcmVxdWVzdCwgY2FsbGJhY2spIHtcbiAgICB2YXIgbWFwLCBwYXRoLCByZWR1Y2UsIHJlZHVjZUFyZ3NBbmRCb2R5LCB2aWV3O1xuICAgIG1hcCA9IHJlcXVlc3QubWFwLCByZWR1Y2UgPSByZXF1ZXN0LnJlZHVjZTtcbiAgICBpZiAoKHJlZHVjZSAhPSBudWxsKSAmJiB0eXBlb2YgcmVkdWNlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZWR1Y2UgPSByZWR1Y2UudG9TdHJpbmcoKTtcbiAgICAgIHJlZHVjZUFyZ3NBbmRCb2R5ID0gcmVkdWNlLnNsaWNlKHJlZHVjZS5pbmRleE9mKCcoJykpO1xuICAgICAgcmVkdWNlID0gXCJmdW5jdGlvbiBcIiArIHJlZHVjZUFyZ3NBbmRCb2R5O1xuICAgIH1cbiAgICB2aWV3ID0ge1xuICAgICAgcmVkdWNlOiByZWR1Y2UsXG4gICAgICBtYXA6IFwiZnVuY3Rpb24gKGRvYykge1xcbiAgaWYgKGRvYy5kb2NUeXBlLnRvTG93ZXJDYXNlKCkgPT09IFxcXCJcIiArIChkb2NUeXBlLnRvTG93ZXJDYXNlKCkpICsgXCJcXFwiKSB7XFxuICAgIGZpbHRlciA9IFwiICsgKG1hcC50b1N0cmluZygpKSArIFwiO1xcbiAgICBmaWx0ZXIoZG9jKTtcXG4gIH1cXG59XCJcbiAgICB9O1xuICAgIHBhdGggPSBcInJlcXVlc3QvXCIgKyBkb2NUeXBlICsgXCIvXCIgKyAobmFtZS50b0xvd2VyQ2FzZSgpKSArIFwiL1wiO1xuICAgIHJldHVybiBjbGllbnQucHV0KHBhdGgsIHZpZXcsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgcmV0dXJuIGNoZWNrRXJyb3IoZXJyb3IsIHJlc3BvbnNlLCBib2R5LCAyMDAsIGNhbGxiYWNrKTtcbiAgICB9KTtcbiAgfTtcblxuICBtb2R1bGUuZXhwb3J0cy5jcmVhdGUgPSBmdW5jdGlvbihkb2NUeXBlLCBhdHRyaWJ1dGVzLCBjYWxsYmFjaykge1xuICAgIHZhciBwYXRoO1xuICAgIHBhdGggPSBcImRhdGEvXCI7XG4gICAgYXR0cmlidXRlcy5kb2NUeXBlID0gZG9jVHlwZTtcbiAgICBpZiAoYXR0cmlidXRlcy5pZCAhPSBudWxsKSB7XG4gICAgICBwYXRoICs9IFwiXCIgKyBhdHRyaWJ1dGVzLmlkICsgXCIvXCI7XG4gICAgICBkZWxldGUgYXR0cmlidXRlcy5pZDtcbiAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoJ2NhbnQgY3JlYXRlIGFuIG9iamVjdCB3aXRoIGEgc2V0IGlkJykpO1xuICAgIH1cbiAgICByZXR1cm4gY2xpZW50LnBvc3QocGF0aCwgYXR0cmlidXRlcywgZnVuY3Rpb24oZXJyb3IsIGJvZHksIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBKU09OLnBhcnNlKGJvZHkpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcblxuICBtb2R1bGUuZXhwb3J0cy5maW5kID0gZnVuY3Rpb24oaWQsIGNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIGNsaWVudC5nZXQoXCJkYXRhL1wiICsgaWQgKyBcIi9cIiwgbnVsbCwgZnVuY3Rpb24oZXJyb3IsIGJvZHksIHJlc3BvbnNlKSB7XG4gICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIG51bGwsIG51bGwpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIGJvZHkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzLmV4aXN0cyA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaykge1xuICAgIHJldHVybiBjbGllbnQuZ2V0KFwiZGF0YS9leGlzdC9cIiArIGlkICsgXCIvXCIsIG51bGwsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcik7XG4gICAgICB9IGVsc2UgaWYgKChib2R5ID09IG51bGwpIHx8IChib2R5LmV4aXN0ID09IG51bGwpKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoXCJEYXRhIHN5c3RlbSByZXR1cm5lZCBpbnZhbGlkIGRhdGEuXCIpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBib2R5LmV4aXN0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcblxuICBtb2R1bGUuZXhwb3J0cy51cGRhdGVBdHRyaWJ1dGVzID0gZnVuY3Rpb24oZG9jVHlwZSwgaWQsIGF0dHJpYnV0ZXMsIGNhbGxiYWNrKSB7XG4gICAgY29uc29sZS5sb2coJ3VwZGF0ZUF0dHJpYnV0ZXMnKTtcbiAgICBhdHRyaWJ1dGVzLmRvY1R5cGUgPSBkb2NUeXBlO1xuICAgIHJldHVybiBjbGllbnQucHV0KFwiZGF0YS9tZXJnZS9cIiArIGlkICsgXCIvXCIsIGF0dHJpYnV0ZXMsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcik7XG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoXCJEb2N1bWVudCBcIiArIGlkICsgXCIgbm90IGZvdW5kXCIpKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIlNlcnZlciBlcnJvciBvY2N1cmVkLlwiKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgSlNPTi5wYXJzZShib2R5KSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgbW9kdWxlLmV4cG9ydHMuZGVzdHJveSA9IGZ1bmN0aW9uKGlkLCBjYWxsYmFjaykge1xuICAgIHJldHVybiBjbGllbnQuZGVsKFwiZGF0YS9cIiArIGlkICsgXCIvXCIsIG51bGwsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcik7XG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoXCJEb2N1bWVudCBcIiArIGlkICsgXCIgbm90IGZvdW5kXCIpKTtcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDQpIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG5ldyBFcnJvcihcIlNlcnZlciBlcnJvciBvY2N1cmVkLlwiKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgbW9kdWxlLmV4cG9ydHMuZGVmaW5lUmVxdWVzdCA9IGZ1bmN0aW9uKGRvY1R5cGUsIG5hbWUsIHJlcXVlc3QsIGNhbGxiYWNrKSB7XG4gICAgdmFyIG1hcCwgcmVkdWNlO1xuICAgIGlmICh0eXBlb2YgcmVxdWVzdCA9PT0gXCJmdW5jdGlvblwiIHx8IHR5cGVvZiByZXF1ZXN0ID09PSAnc3RyaW5nJykge1xuICAgICAgbWFwID0gcmVxdWVzdDtcbiAgICB9IGVsc2Uge1xuICAgICAgbWFwID0gcmVxdWVzdC5tYXA7XG4gICAgICByZWR1Y2UgPSByZXF1ZXN0LnJlZHVjZTtcbiAgICB9XG4gICAgcmV0dXJuIGRlZmluZShkb2NUeXBlLCBuYW1lLCB7XG4gICAgICBtYXA6IG1hcCxcbiAgICAgIHJlZHVjZTogcmVkdWNlXG4gICAgfSwgY2FsbGJhY2spO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzLnJ1biA9IGZ1bmN0aW9uKGRvY1R5cGUsIG5hbWUsIHBhcmFtcywgY2FsbGJhY2spIHtcbiAgICB2YXIgcGF0aCwgX3JlZjtcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBfcmVmID0gW3t9LCBwYXJhbXNdLCBwYXJhbXMgPSBfcmVmWzBdLCBjYWxsYmFjayA9IF9yZWZbMV07XG4gICAgfVxuICAgIHBhdGggPSBcInJlcXVlc3QvXCIgKyBkb2NUeXBlICsgXCIvXCIgKyAobmFtZS50b0xvd2VyQ2FzZSgpKSArIFwiL1wiO1xuICAgIHJldHVybiBjbGllbnQucG9zdChwYXRoLCBwYXJhbXMsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvcik7XG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IodXRpbC5pbnNwZWN0KGJvZHkpKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgYm9keSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgbW9kdWxlLmV4cG9ydHMucmVxdWVzdERlc3Ryb3kgPSBmdW5jdGlvbihkb2NUeXBlLCBuYW1lLCBwYXJhbXMsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHBhdGgsIF9yZWY7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgX3JlZiA9IFt7fSwgcGFyYW1zXSwgcGFyYW1zID0gX3JlZlswXSwgY2FsbGJhY2sgPSBfcmVmWzFdO1xuICAgIH1cbiAgICBpZiAocGFyYW1zLmxpbWl0ID09IG51bGwpIHtcbiAgICAgIHBhcmFtcy5saW1pdCA9IDEwMDtcbiAgICB9XG4gICAgcGF0aCA9IFwicmVxdWVzdC9cIiArIGRvY1R5cGUgKyBcIi9cIiArIChuYW1lLnRvTG93ZXJDYXNlKCkpICsgXCIvZGVzdHJveS9cIjtcbiAgICByZXR1cm4gY2xpZW50LnB1dChwYXRoLCBwYXJhbXMsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgcmV0dXJuIGNoZWNrRXJyb3IoZXJyb3IsIHJlc3BvbnNlLCBib2R5LCAyMDQsIGNhbGxiYWNrKTtcbiAgICB9KTtcbiAgfTtcblxufSkuY2FsbCh0aGlzKTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS44LjBcbihmdW5jdGlvbigpIHtcbiAgdmFyIGdldFRva2VuLCBwbGF5UmVxdWVzdDtcblxuICBnZXRUb2tlbiA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgY29uc29sZS5sb2coJ2dldFRva2VuJyk7XG4gICAgd2luZG93LnBhcmVudC5wb3N0TWVzc2FnZSh7XG4gICAgICBhY3Rpb246ICdnZXRUb2tlbidcbiAgICB9LCAnKicpO1xuICAgIHJldHVybiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICB2YXIgaW50ZW50O1xuICAgICAgaW50ZW50ID0gZXZlbnQuZGF0YTtcbiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFwibWVzc2FnZVwiLCBhcmd1bWVudHMuY2FsbGVlKTtcbiAgICAgIHJldHVybiBjYWxsYmFjayhpbnRlbnQpO1xuICAgIH0pO1xuICB9O1xuXG4gIG1vZHVsZS5leHBvcnRzID0ge1xuICAgIGdldDogZnVuY3Rpb24ocGF0aCwgYXR0cmlidXRlcywgY2FsbGJhY2spIHtcbiAgICAgIHJldHVybiBwbGF5UmVxdWVzdCgnR0VUJywgcGF0aCwgYXR0cmlidXRlcywgZnVuY3Rpb24oZXJyb3IsIGJvZHksIHJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvciwgYm9keSwgcmVzcG9uc2UpO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBwb3N0OiBmdW5jdGlvbihwYXRoLCBhdHRyaWJ1dGVzLCBjYWxsYmFjaykge1xuICAgICAgcmV0dXJuIHBsYXlSZXF1ZXN0KCdQT1NUJywgcGF0aCwgYXR0cmlidXRlcywgZnVuY3Rpb24oZXJyb3IsIGJvZHksIHJlc3BvbnNlKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnJvciwgYm9keSwgcmVzcG9uc2UpO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBwdXQ6IGZ1bmN0aW9uKHBhdGgsIGF0dHJpYnV0ZXMsIGNhbGxiYWNrKSB7XG4gICAgICBjb25zb2xlLmxvZygncHV0Jyk7XG4gICAgICByZXR1cm4gcGxheVJlcXVlc3QoJ1BVVCcsIHBhdGgsIGF0dHJpYnV0ZXMsIGZ1bmN0aW9uKGVycm9yLCBib2R5LCByZXNwb25zZSkge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2soZXJyb3IsIGJvZHksIHJlc3BvbnNlKTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgZGVsOiBmdW5jdGlvbihwYXRoLCBhdHRyaWJ1dGVzLCBjYWxsYmFjaykge1xuICAgICAgcmV0dXJuIHBsYXlSZXF1ZXN0KCdERUxFVEUnLCBwYXRoLCBhdHRyaWJ1dGVzLCBmdW5jdGlvbihlcnJvciwgYm9keSwgcmVzcG9uc2UpIHtcbiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yLCBib2R5LCByZXNwb25zZSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgcGxheVJlcXVlc3QgPSBmdW5jdGlvbihtZXRob2QsIHBhdGgsIGF0dHJpYnV0ZXMsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHhocjtcbiAgICB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7XG4gICAgeGhyLm9wZW4obWV0aG9kLCBcIi9kcy1hcGkvXCIgKyBwYXRoLCB0cnVlKTtcbiAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgICBjb25zb2xlLmxvZyh4aHIucmVzcG9uc2UpO1xuICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHhoci5yZXNwb25zZSwgeGhyKTtcbiAgICB9O1xuICAgIHhoci5vbmVycm9yID0gZnVuY3Rpb24oZSkge1xuICAgICAgdmFyIGVycjtcbiAgICAgIGVyciA9ICdSZXF1ZXN0IGZhaWxlZCA6ICN7ZS50YXJnZXQuc3RhdHVzfSc7XG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyKTtcbiAgICB9O1xuICAgIHJldHVybiBnZXRUb2tlbihmdW5jdGlvbihyZXMpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdhZGRFdmVudExpc3RlbmVyJyk7XG4gICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdBdXRob3JpemF0aW9uJywgJ0Jhc2ljICcgKyBidG9hKHJlcy5hcHBOYW1lICsgJzonICsgcmVzLnRva2VuKSk7XG4gICAgICBpZiAoYXR0cmlidXRlcyAhPSBudWxsKSB7XG4gICAgICAgIHJldHVybiB4aHIuc2VuZChKU09OLnN0cmluZ2lmeShhdHRyaWJ1dGVzKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4geGhyLnNlbmQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcblxufSkuY2FsbCh0aGlzKTtcbiJdfQ==
